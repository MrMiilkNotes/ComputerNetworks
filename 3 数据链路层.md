# 基本概念

## 数据链路层干了什么？

​	数据链路层的最基本的职责是将来自网络层的数据可靠地传输到**相邻节点**的主机的网络层，虽然实际上的数据链路层没能做到(真正的可靠)这点，但是它做到了“保证网络层收到的数据都是无误的” -- 不保证目标主机能收到所有数据。可以先从一个简单的双主机的通讯模型开始分析。

<img src="3 数据链路层.assets/1569941487949.png" alt="1569941487949" style="zoom: 50%;" />

​	如图所示，一个简单的双主机的通讯模型，路由器只覆盖到网络层。对于链路层来说，物理层做的事是透明的，链路层只需要确保拿到规定的输入，做出规定的输出，因此可以单独把链路层拎出来讨论。对于网络层来说，数据同样是透明的，这是数据链路层的基本机制之一，称为透明传输。

​	数据链路层不是一股脑将数据丢到链路上，而是对来自网络层的数据做好处理，这个处理有点类似为邮件加的包装盒，将上面的图放大：

<img src="3 数据链路层.assets/1569942597199.png" alt="1569942597199" style="zoom:50%;" />

​	这个机制称为封装成帧，产物称为帧，它是数据链路层的基本数据传输单位。帧在原本数据的基础上加了用于本层传输必要的信息(按本层的协议)，同时，它也是数据链路层的另一个机制的基础，差错检验。

​	这三个机制总结自上面的双主机通讯，也可以更抽象地称为点对点信道。数据链路层中使用的信道并不只是这种方式，还有一种是广播的方式。

​	广播是多个体间的通讯，这部分除了前面强调的几个机制，还应当考虑**编址**(标识)和**协调**(信道公用)这两个问题。广播信道的典型代表是局域网(P69:从整个互联网来看，局域网仍属于数据链路层的范围)。

​	局域网使用的是广播信道，现如今所说的局域网通常都是指基于DIX Ethernet V2标准的以太网，IEEE所提出的802.3并没能存活下来，在IEEE的802.3中，数据链路层被分为LLC(逻辑链路控制)和MAC(媒体接入控制)，但随着802.3的淡去，LLC如今已经不再使用，只剩下MAC。

​	因此，现如今谈及局域网，近乎就是以太网，而以太网中的数据封装就是MAC帧。

## 链路层的一些定义

#### 链路(link)

​	无源的点到点的物理线路段，中间无其他的交换结点

#### 数据链路(data link)

​	除物理线路外，还须有通信协议来控制数据的传输。把实现这些协议的硬件和软件加到链路上，就构成了数据链路。

- 常用网络适配器(即网卡)来实现这些协议
- 适配器包括了数据链路层和物理层这两层的功能

# 三个基本机制

## 封装成帧(framing)

​	<img src="3 数据链路层.assets/1570086264809.png" alt="1570086264809" style="zoom:50%;" />

​	既然比特流是一维的存在，那它的封装就是加头加尾了，通常来说，帧头是SOH(start of heading)，帧尾是EOT(end of trains)。

​	MTU是指最大传送单元，不包括头尾。

## 透明传输

​	封装成帧中，会遇到的问题是想要传输的数据包含了SOH, EOT这样的字符：

<img src="3 数据链路层.assets/1570086622080.png" alt="1570086622080" style="zoom:50%;" />

​	这种问题的解决方式就仁者见仁了，但是可以联系到字符串中的格式化字符串问题，转义字符也成为了“标准”的解决方式

<img src="3 数据链路层.assets/1570086849046.png" alt="1570086849046" style="zoom:50%;" />

​	数据链路层在为网络层提供传输数据的服务时，不应当对来自网络层的数据提出限制，即使是数据链路层本身用于作为帧分隔符的数据。

## 差错控制

​	**差错检验**和差错校正是不同的，这也是数据链路层没完成的点。实际的数据链路层中提供的机制是差错检验，而且丢弃出错的包，它没能提供差错校正是出自于效率问题，作业一的补充题对此进行了描述，但是并没有实际数据对两种机制进行分析。

>  误码率(BER)：在一段时间内，传输错误的比特占所传输比特总数的比率

​	在实际使用中，差错检验使用的是**循环冗余检验(CRC)**：双方商定一个n+1位的除数P，发送数据的时候将二进制码左移n位并除以P，得到的余数称为帧检验序列(FCS)，将其附着在要发送的数据后面，接收者进行同样的计算来检测数据的正确性，只有计算结果为0，才认为传输的数据没有出错。这里虽然说除法，但实际计算使用的是**异或**，可以参考作业例题

​	经过CRC的检验，如果数据出现了错误(称为**比特差错**)，会被直接丢弃。但是在传输过程中出现的帧丢失，帧重复，帧失序并不属于差错检验的管辖范围。

# 两种信道类型

## 点对点信道 -- PPP

​	在点对点信道中，最常使用的协议是点对点协议(PPP, point to point protocol)。PPP是用户计算机和ISP通讯时使用的数据链路层协议，互联网用户通常需要连接到某个ISP才能接入到互联网

> ISP: internet service provider

<img src="3 数据链路层.assets/1570173276387.png" alt="1570173276387" style="zoom: 33%;" />

> PPP属于广域网范畴，MAC是局域网范畴，按实际情况和环境就选用不同的协议，PPP支持的网络结构只能是点对点，MAC支持多点对多点。

### PPP的责任

​	PPP处于数据链路层中，基于之前的讨论，PPP必须满足三个基本机制。PPP设计者在三个基本的机制以外，对PPP的实现提出了更加具体的需求，从需求和后面的描述中可以看到，PPP不是纯粹的数据链路层协议，它其实包含了物理层和网络层的内容：

| 需求           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 简单           | **首要需求**，TCP/IP协议栈中最复杂的部分在TCP协议。PPP对数据的处理就只有一个CRC |
| 封装成帧       |                                                              |
| 透明性         |                                                              |
| 差错检测       |                                                              |
| 多种网络层协议 | 在同一条物理链路上同时支持多种网络层协议                     |
| 多种类型链路   | 串行，并行，同步，异步，光，电.... 这两点分别面向网络层和物理层，也算是透明性的内容 |
| 检测连接状态   |                                                              |
| 最大传送单元   |                                                              |
| 网络层地址协商 | 使得互相通讯的两个网络层能够通过协商来获得彼此网络层地址     |
| 数据压缩协商   |                                                              |

### PPP的组成

​	**PPP的层次模型**：

<img src="3 数据链路层.assets/1572620161577.png" alt="1572620161577" style="zoom: 67%;" />

- 一个将 IP 数据报封装到串行链路的方法：就是将来自网络层的数据封装到帧的方法

- 一个链路控制协议 LCP (Link Control Protocol)：面向物理层部分，用于链路的建立，配置和测试

- **一套**网络控制协议 NCP(Network Control Protocol)：面向网络层部分，每个协议对应不同的网络层协议，可以看上面的模型

### PPP的帧格式

​	在具体的PPP中，帧有了面向实际使用的具体格式：

- 首部的F(flag), A(address), C(control)是固定的，协议字段：0x0021表示信息部分为IP数据报，0x8021表示信息部分为网络层的控制数据，0xC021, 则信息字段是 PPP 链路控制数据。

> 这部分知识可能已经过期

- 尾部FCS为帧检验序列
- 信息部分(IP数据报)不超过1500字节

<img src="3 数据链路层.assets/1570175476153.png" alt="1570175476153" style="zoom: 33%;" />

#### 机制

PPP中透明传输的实现方式

- 字节填充：在异步传输链路中。字节填充使用的转义字符是0x7D。
- 零比特填充：在同步传输链路中(SONET/SDH)。具体地，在发送数据中如果发现有连续5个1，即填入一个0。界定字符可以使用0x7E(即Flag)。

> 数据通信可分为同步通信和异步通信两大类：
>
> - 同步通信要求接收端时钟频率和发送端时钟频率一致。发送端发送连续的比特流
> - 异步通信时不要求接收端时钟和发送端时钟同步。发送端发送完一个字节后，可经过任意长的时间间隔再发送下一个字节，异步通信的通信开销较大，但接收端可使用廉价的、具有一般精度的时钟来进行数据通信  

### PPP的工作状态



<img src="3 数据链路层.assets/1570176065194.png" alt="1570176065194" style="zoom: 33%;" />

​	这里的物理层连接建立并不是说网线连着，而是用户拨号接入ISP(个人电脑的调制解调器呼叫路由器....)。在宿舍的时候，如果将网线直接插入电脑，需要自己拨号上网。

<img src="3 数据链路层.assets/1570428595892.png" alt="1570428595892" style="zoom: 80%;" />

​	之后用户主机会通过向ISP发送LCP分组进行LCP协商，目的是选择一些将要使用的PPP参数。随后可能会进行(不一定有的)身份验证，即鉴别。NCP配置部分会根据网络层的不同协议交换相应的控制分组，如果PPP链路上运行的是IP协议，则会分配IP地址，从而PC可以接入互联网。

## 广播信道 -- 以太网

### 物理基础

​	局域网的连接方式有星形，环形，总线网等，其中，使用了集线器的星形连接和总线网是一样的，而使用交换机的星形连接则不同。

<img src="3 数据链路层.assets/1570435057273.png" alt="1570435057273" style="zoom:67%;" />

​	用户接入局域网是通过一个称为适配器的设备(以前是独立的网卡，如今经常集成在主板上)，适配器有独立的处理器和存储器，负责了数据链路层和物理层部分，因此，对于计算机的CPU来说，只需要将想要发送的IP数据报发送给适配器和从适配器取走收到的IP数据报。

<img src="3 数据链路层.assets/1570435024209.png" alt="1570435024209" style="zoom:67%;" />

​	硬件地址，即MAC(medium access control, 媒体接入控制)地址，书中特地强调了它有别于地址的通常含义(即说明位置在哪里)，更像是一个名字，或者说是接口标识。



下面的讨论基于“传统以太网”

> 以太网使用的是曼切斯特编码，这个编码可以参考物理层中的介绍
>
> 电磁波在1km的电缆的传播时间约为5微秒
>
> “传统以太网”：速率为10Mbit/s

### 协调问题

​	协调问题的前导是共享信道，即同一局域网的用户共享数据的问题，前面介绍过的静态划分信道(频分，码分，波分...)在代价上过高，因此以太网使用的是动态媒体接入控制(即多点接入)中的随机接入(另一种是受控接入)。在随机接入方式中，用户可以随机发送信息，但是需要协议来解决多个用户同时发送信息的问题，即碰撞

​	和前面PPP类似，以太网提供的服务也是尽力而为，因此会直接丢弃错误帧。在此基础上，以太网通过CSMA/CD(载波监听多点接入/碰撞检测)协议来解决碰撞。

- 多点接入：说明以太网为**总线型**网络
- 载波监听：即检测信道，在数据发送前和发送过程中不断检测信道
- 碰撞检测：通过对信道的检测，如果发现有多个用户在发送数据，即发生碰撞，就停止发送，并等待一段时间再重新发送

<img src="3 数据链路层.assets/1570437598661.png" alt="1570437598661" style="zoom:80%;" />

> $\tau$: 总线上单程端到端传播时延 --- 没有考虑转发产生的时延，**还是说这个传播时延和之前说的传播时延不同**
>
> $2\tau$: 争用期(contention period) or 碰撞窗口(collision window)
>
> 电磁波在1km的电缆的传播时间约为5微秒

​	从这几个机制可以看出，CSMA/CD协议属于半双工通讯。发送的数据如果在争用期内没有发生碰撞，即说明了不会再发生碰撞。

#### 1 如果发生了碰撞

​	发生碰撞的帧会被直接丢弃，然后使用**截断二进制指数退避**来确定重传的时机。协议规定$2\tau=51.2$微秒(这个规定限制了以太网的范围)，对于10Mbit/s的以太网即512bit时间，具体算法：

- 确定基本退避时间，一般是取为争用期 2$\tau$。

- 定义重传次数 *k* ，

  ​                 *k* = Min[重传次数, 10]

- 从整数集合[0,1,…, (2^k^ -1)]中随机地取出一个数，记为 *r*。重传所需的时延就是 *r* 倍的基本退避时间。

- 当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告。 

#### 2 如果数据太短以至于碰撞前已经发送完成

​	协议规定以太网最短帧长为64字节，即512bit，如果数据过短，就直接用字节填充，对于这些填充的字节，IP协议有机制将其抛弃(长度)

> 最短帧长=$2\tau × 10Mbit/s$
>
> 实际发送的MAC帧前面还会有8字节的前同步码(看下面的MAC帧格式)

#### 3 CSMA/CD过程

#### 4 其他

​	**强化碰撞**：为了让所有用户都知道发生碰撞，当发生碰撞后会要求继续发送32(或48)bit信息

<img src="3 数据链路层.assets/1570439258593.png" alt="1570439258593" style="zoom:67%;" />

​	协议还规定了帧间最小间隔为9.6微秒，即96bit时间。所以，检测到总线开始空闲后，还要等待 9.6 ms 才能再次发送数据  

​	**信道利用率**：争用期，等待，传播时延等....

#### 4 发送消息的具体流程

​	作业题有具体题目。

### 编址问题

​	局域网的identify问题，使用广播信道对目标传送数据的时候需要identify。

​	使用了MAC地址，它由6字节构成，前面3字节由IEEE出售，在前面3字节中，有两个特殊的位，一个是用于标识是否是全球的地址，一个用于标识单个地址或组地址，后面三个字节由买到前面三个字节的组织自行编址。

> 关于MAC-48：
>
> 第一个字节的最低位：Individual/Group：
>
> - I/G=0, 单个地址
> - I/G=1，组地址
>
> 第一个字节的最低第二位：Global/Local
>
> - G/L=0, 全球管理
> - G/L=1，本地管理

### 帧格式

​	这里的帧称为MAC帧

<img src="3 数据链路层.assets/1570439334108.png" alt="1570439334108" style="zoom: 80%;" />

​	从数据链路层发到物理层时会在前面加入8个字节，这8字节由两个字段构成，分别是7字节的前同步码，用于让接收端的适配器能调整自己的时钟频率，最后一个字节是帧开始界定符，最后两个1表明了以太网帧的开始。

​	在MAC帧中，可以明显地看到和PPP帧的区别，有源地址和目的地址，两个都是MAC地址，随后的类型字段标识的是网络层协议(type)，最后再附上FCS

​	相比PPP帧，可以发现MAC帧没有结束标识，这是因为以太网使用的是曼切斯特编码。

> 上面的讨论都是基于传统以太网

### 以太网拓展

#### 物理上的拓展

​	以太网的拓展可以从两层考虑，分别是物理层和数据链路层。

##### 集线器

​	物理层的拓展现在已经很少用了，它的方式是使用集线器，甚至可以使用多层集线器，如果集线器间用光纤连接，范围就会更广。这种方式有个很大的缺点，就是整个局域网是同一个碰撞域。

<img src="3 数据链路层.assets/1570503404675.png" alt="1570503404675" style="zoom:80%;" />

​	数据链路层的拓展得益于集成技术的发展而带来的交换机。

##### 交换机

​	最初使用的是网桥，后来交换机替代了网桥。

​	使用了交换机的局域网和前面讨论的传统以太网有很大的区别，它是星形连接的方式，每个接口可以连接别的交换机或者主机，工作在**全双工**的方式，并且主机间可以**无碰撞**地传输数据。交换机接口有存储器，能实现帧暂存。工作机制可以看作业例题

​	**最大的优点**

​	使用以太网交换机时，假设每个接口到主机的带宽还是 10 Mb/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此对于拥有 ***N* 对接口**的交换机的总容量为 $N×10 Mb/s$，而如果是集线器，则是$\frac{10}{N}Mb/s$

​	交换机内部有一个可以适应网络连接的交换表，它可以随着网络工作来自学连接的主机，即记录端口传过来的消息的MAC地址，然后通过设置超时来确保时效性。

​	为了避免多个交换机连接的时候出现消息在交换机之间不断循环的现象(如果连接中出现了环就会发生)，IEEE制定了生成树协议(STP，IEEE 802.1D)，它会在逻辑上切断一些链路，从而避免网络拓扑中出现环状结构。

> 交换机需要和主机一样发送帧，因此会增加时间花费，可以看作业题目

> **以太网的演化**：
>
> 传统电话网采用星状结构，中心是电话交换机
>
> 初期的以太网采用无源总线结构
>
> - CSMA/CD，半双工
> - 随着站点数目增多，可靠性下降
>
> 基于交换机的星形结构
>
> - 不再有CSMA/CD
> - 全双工

#### 虚拟局域网(VLAN)

​	VLAN 是由一些**局域网网段构成的与物理位置无关的逻辑组**，只有逻辑组之间能进行广播通讯。虚拟局域网的划分有利于避免整个局域网中过多的广播消息，也有利于数据安全

<img src="3 数据链路层.assets/1570504425619.png" alt="1570504425619" style="zoom: 50%;" />

​	而为了使用VLAN，原本的MAC帧必须加入标识来区分不同的逻辑分组

<img src="3 数据链路层.assets/1570504505238.png" alt="1570504505238" style="zoom: 67%;" />

> CFI位常被置为1(规范式);对于802.5令牌环网和FDDI,该位为0（非规范式）
>
> 规范式中，优先发送最右边的位；非规范式中，优先发送最左边的位  

#### 高速以太网

​	速率达到或超过 100 Mb/s 的以太网称为**高速以太网**  

#### 无线网

​	隐蔽站问题：多个站覆盖范围不同，可能出现和交集处的主机同时通讯。安全性问题。

<img src="3 数据链路层.assets/1570851190623.png" alt="1570851190623" style="zoom:67%;" />

​	使用CSMA/CA来处理冲突。如图，A发送RTS，C能收到，进入NAV，D不能收到，但是能收到B发出发CTS。

<img src="3 数据链路层.assets/1570851495816.png" alt="1570851495816" style="zoom: 50%;" />

# 补充

## 纠错码

​	码字（codeword）：一个帧包括m个数据位，r个校验位，n = m + r，则此n比特单元称为n位码字

​	海明距离（Hamming distance）：两个码字之间不同的比特位数目

> ​      如果两个码字的海明距离为d，则需要d个单比特的错误就可以把一个码字转换成另一个码字  
>
> ​     为了检查出d个错(单比特错) ，需要使用海明距离为 d + 1 的编码  
>
> ​     为了纠正d个错，需要使用海明距离为 2d + 1 的编码  

例：

​	设计一位纠错码，要求：m个信息位，r个校验位，纠正单比特错。

​		$m$个信息位可以表示$2^m$个信息，而对于其中每个信息，都会有n个海明距离为1的无效编码，为了**检测**出错误，应当使用海明距离为2的编码，即：
$$
(n+1)2^m\leq2^n
$$
可以理解为：按上面分析需要的编码总数(包括无效的编码)应当少于能编码的总数($n$位)。

为了能纠正错误，应该使用海明距离为3的编码，即：
$$
(\frac{n(n-1)}{2}+1)2^m\leq2^n
$$

### 海明码

​	从左向右，从1开始计数(称为位号)，即第一位，第二位...。位号为2的幂的位是校验位，其余是信息位。

​	每个校验位确保自己在内的**一些位**的奇偶校验和为偶数

​	数据位：上面所说的一些位是指：数据位的位号表示成二进制后，对应“那一位为1就会对第几个校验位产生影响”。比如11D=1011B，则编码中的1，2，8都会被这位影响

​	接受过程：

<img src="3 数据链路层.assets/1572656834688.png" alt="1572656834688" style="zoom:80%;" />

> 挺好的，不过感觉这样编码太费事了

例：

​	     1001000 --> 00110010000  

<img src="3 数据链路层.assets/1572656968531.png" alt="1572656968531" style="zoom:67%;" />

## 中间设备

| 中间设备                |            |
| ----------------------- | ---------- |
| 转发器(repeater) 集线器 | 物理层     |
| 网桥(bridge) 交换机     | 数据链路层 |
| 路由器(router)          | 网络层     |
| 网关(gateway)           | 网络层以上 |

