## 运输层干了什么

​	网络层为主机之间提供逻辑通讯，而运输层为应用程序之间提供端到端的逻辑通讯。书上将“从主机到应用程序”的这种拓展称为**multiplexing**和**demultiplexing**，即发送方多个应用进程能用同一个运输层协议传送，发送方能在解析完头部后正确交付数据。

> 逻辑通讯：只要把数据丢给下一层，下一层就可以把数据交付到对方的本层

​	面向通讯的最高层，用户功能的最底层，屏蔽了网络核心部分以及细节，提供应用程序间的端到端的“逻辑信道”

### 协议端口号(protocol port number)

​	"协议栈层间的抽象的协议端口，和路由，交换机的硬件端口毫无关系"，可以将这个端口理解为“门牌”，通过IP地址传到本机后通过“门牌”区分应用程序

​	通常端口分为服务器端使用端口和用户端使用端口(49152-65535)，其中服务器端使用端口又分为**系统端口**(0-1023)和登记端口(1024-49151)

<img src="5_运输层.assets/1573001746276.png" alt="1573001746276" style="zoom:25%;" />

### 协议

​	运输层的两个主要协议代表的近乎是两种极端。UDP类似“传输层”实现的**最小集**，即运输层的满足基本要求，而TCP则是加入了对可靠性的要求，相对地也牺牲了一定的性能。

## UDP

​	所谓**最小集**，其实现的基本功能差不多只有**multiplexing**，**demultiplexing**和差错检验。对UDP的理解可以从其特性出发，

- UDP是无连接的，支持单点和多点的任意组合的通讯

- UDP在可靠性上没有付出什么努力，因此依旧是“尽最大努力交付”而且没有堵塞控制

  > 这里所谓堵塞控制，包括了之前ICMP提到的一些功能，比如源点抑制，信道堵塞等
  >
  > <font color='red'>UDP不会使用ICMP？ICMP若属于网络层，那为什么说UDP不能提供拥塞控制？</font>

- UDP的“最小集”实现让它的首部只有8字节

- “面向报文”的。不会拆分数据，直接交付来自应用程序的完整报文，报文的长度由应用程序负责控制

### 首部

​	<img src="5_运输层.assets/1573002691587.png" alt="1573002691587" style="zoom: 33%;" />

非常“naive”。

**检验和计算**

​	检验和的计算和IP头部检验和计算类似，但是会加入伪首部

## TCP

​	在“最小集”的基础上加入可靠传输。可靠传输的实现基于三个基本机制：连接，流量控制，拥塞控制。

> 在讨论TCP的时候，可靠传输指的通常是建立连接，注意区分。

​	作为和UDP的区分，可以看一下TCP的特点：

- 面向连接的，只能点对点的通讯，支持全双工通信

  > 这里的点(endpoint)是指socket

- 可靠交付

- “面向字节流”。对于TCP来说传输什么无所谓(都是无结构的0，1流)

### 连接

​	TCP经常会被称为“TCP连接”，因为TCP最大的特点就是这个连接。TCP既然是连接，那第一个问题就是连接的是什么 -- endpoint，它是IP和protocol port的结合，称为socket
$$
TCP\ conn ::=\{socket_1, socket_2\}::=\{(IP_1:port_1),(IP_2,port_2)\}
$$
