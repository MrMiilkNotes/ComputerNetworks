# 基本概念

## 网络层干了什么

网络层应当向运输层提供怎样的服务，**面向连接还是面向无连接**？

​	面向连接的服务借鉴于电信的电话网，可以建立提供有序，可靠的传输，但是会占用“虚电路”的网络资源

​	面向无连接的方式是将数据分组发送，提供“尽力”的服务。当初提出以及最终应用无连接的方式有原因是：基于计算机很强的差错处理能力，能接受网络层提供这种“尽力”的服务

​	网络层最首要的问题是**多网络的互联问题**，各种网络可能差异巨大，以太网，卫星链路等。如何将繁多的网络统一，向上提供抽象？对各种网络制定一个标准的方式并不适合，因为各种异构网络差异巨大，后来提供的解决方式是类似“网络层为各种异构网络提供适配器”的方式：使用IP协议让性能各异的网路在网络层上看起来像是一个统一的网络 - 虚拟互联网。

## IP协议

<img src="4_网络层.assets/1571450850047.png" alt="1571450850047" style="zoom:50%;" />

​	IP协议的实现还依赖于另外三个协议：

- ARP(address resolution protocol)
- ICMP(internet control message protocol)
- IGMP(internet group management protocol)

  其中，ARP协议工作在数据链路层和网络层之间，为IP协议工作提供支持，而ICMP和IGMP基于IP协议为上层提供服务。

## IP地址

​	网络层既然想解决“多网互联”，那就必须解决“标识”问题，即在庞大的互联网中“谁是谁”的问题，这不只是“identify”，而且需要“location”。在数据链路层中我们使用了MAC地址来解决“identify”，由于局域网规模小，因此使用广播的方式，也避免了“location”问题，但是“广播”明显不能再用在互联网上了，这时候我们需要真正的“地址”，这就是IP地址。

​	IP地址到现在经历过了三个阶段

- 分类的IP地址
- 子网划分
- 构成超网

  这几个阶段其实解决的主要问题是IP地址不够用



# IP协议栈

## IP协议

### IP地址

#### 分类的IP地址

<img src="4_网络层.assets/1571452455910.png" alt="1571452455910" style="zoom: 33%;" />

​	前面部分为网络号，后面部分为主机号

#### 子网划分

​	子网划分发生在一个具体的某类地址下，是对这个网络中主机更加灵活的管理。子网号是借用了几个主机号而构成的，因此主机号会变少，其具体的实现是，路由器通过子网掩码来确定子网地址，然后进行转发。

<img src="4_网络层.assets/1571453328933.png" alt="1571453328933" style="zoom:33%;" />

#### 构成超网

1. 网络前缀

   ​	无分类域间路由选择(CIDR)，去除了A，B，D等的地址分类，同样是两级分址，但是网络号的长度不再是固定的了，这时候网络号称为网络前缀

2. 最长前缀匹配
	​	由于使用CIDR会有“地址聚合”的效果，在路由表中进行匹配的时候应该选择网络前缀最长匹配的IP地址，这样可以尽可能地缩小范围
	
3. 二叉线搜索

  ​	类似哈夫曼编码所使用的键树

### IP数据报

​	<img src="4_网络层.assets/1571455075159.png" alt="1571455075159" style="zoom:50%;" />

**首部检验和**：16位，只检验数据报的首部。

<img src="4_网络层.assets/1571455245185.png" alt="1571455245185" style="zoom: 44%;" />

### 路由表

​	表项：**（目的网络地址，下一条地址）**

​	默认路由：对某些规则的IP地址设置其跳转到某个地址

路由表的具体运行机制还需要其他协议。




> 至此，从网络层向下的具体通讯过程：IP数据报填写源地址，目的地址，丢到数据链路层后，由数据链路层的网络接口软件负责将“下一条地址”转化成目标MAC地址，然后将IP数据报封装成帧，填写源和目的MAC地址，然后通过链路传输，到达目的之后向上解析。
>
> - 主机或者路由器如何将“下一条的IP地址”转化成MAC地址？
> - 路由器中的路由表是何种运行机制？
>
> 其中第一个问题的答案即ARP协议



## ARP

### 用途

​	从网络层的IP地址解析出在数据链路层应当使用的MAC地址。因此，ARP是工作在数据链路层和网络层间的协议。

### 实现

​	使用ARP catch缓存**局域网**中各主机和路由的IP地址与其MAC地址的映射。既然是查表，那就是使用的时候查呗，应当关注的是表的建立过程：主机(出于需要)在局域网中发送ARP请求分组，内容差不多是*我的IP是：xxx，MAC是：xxx，IP为：yyy的MAC是多少啊*，局域网中只有IP为*yyy*的主机(如果存在)会回复ARP响应分组：*"我的IP是：yyy，MAC是：yyy"*。注意这里请求分组是广播发送，而响应分组是单播(从一个源到一个目的)

​	其他：源和目的主机都会缓存对方的IP与MAC映射。同样有超时失效

​	注意：ARP**是局域网上的**，不能跨越局域网，对于跨越局域网的分组，是直接发送到路由器上，通过路由器转发。

> 问题：如果是一个路由器连接着多个路由器，如何确定要把分组发到哪个路由器来实现跨局域网？ -- 路由表配置默认路由